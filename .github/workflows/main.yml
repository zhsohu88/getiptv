name: Run getiptv script  # å·¥ä½œæµç¨‹åç§°

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:           # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©åŒ—äº¬æ—¶é—´ 07:00ï¼‰
    - cron: '0 23 * * *'  # GitHub ä½¿ç”¨ UTC æ—¶é—´ï¼Œ23:00 UTC = åŒ—äº¬æ—¶é—´ 07:00

permissions:
  contents: write  # å…è®¸æ¨é€æ›´æ”¹åˆ°ä»“åº“

jobs:
  run-script:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu è™šæ‹Ÿç¯å¢ƒ

    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–åº“
        run: |
          pip install requests chardet

      - name: â–¶ï¸ è¿è¡Œ getiptv.py è„šæœ¬
        run: python getiptv.py

      - name: ğŸ“ æäº¤æ›´æ–°ï¼ˆä»…å½“æ–‡ä»¶æœ‰å˜æ›´ï¼‰
        run: |
          if [ -f "user_local.txt" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add user_local.txt

            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆé¿å…ç©ºæäº¤ï¼‰
            if ! git diff --cached --quiet; then
              git commit -m "Update user_local.txt from getiptv.py"
              git push
              echo "âœ… å·²æäº¤æ›´æ–°"
            else
              echo "ğŸ“ æ–‡ä»¶æœªå˜åŒ–ï¼Œæ— éœ€æäº¤"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° user_local.txtï¼Œè·³è¿‡æäº¤æ­¥éª¤"
